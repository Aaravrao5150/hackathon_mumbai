<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Analytics</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="firebase-init.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="profile-header">
        <div class="avatar">ðŸŽ“</div>
        <h2 id="u-roll" style="margin:0; font-size:18px;">Student</h2>
        <p style="margin:4px 0 0; font-size:12px; opacity:0.7;">Computer Science Dept.</p>
    </div>

    <div class="dashboard-container">
        
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Total</h4>
                <p id="st-total">0</p>
            </div>
            <div class="stat-card">
                <h4>Present</h4>
                <p id="st-present" style="color:#10b981">0</p>
            </div>
            <div class="stat-card">
                <h4>Late</h4>
                <p id="st-late" style="color:#f59e0b">0</p>
            </div>
        </div>

        <div class="chart-row">
            
            <div class="chart-card">
                <h3 style="margin:0 0 5px 0; font-size:11px; color:#64748b; align-self:flex-start; font-weight:700;">ATTENDANCE</h3>
                
                <div class="chart-wrapper">
                    <canvas id="attChart"></canvas>
                    
                    <div class="chart-center-text">
                        <div class="percentage-big" id="center-score">0%</div>
                        <div class="percentage-label">Rate</div>
                    </div>
                </div>
            </div>

            <div class="news-card">
                <div class="news-badge">CAMPUS UPDATES</div>
                <div class="news-title">Final Semester Exams Schedule Released</div>
                <p class="news-desc">
                    Exams commence May 15th. Check the student portal for hall tickets.
                </p>
                <div class="news-deco"></div>
            </div>

        </div>

        <div class="section-title">RECENT ACTIVITY</div>
        <div id="roster" class="session-list">
            <div style="padding:20px; text-align:center; color:#94a3b8; font-size:13px;">Loading data...</div>
        </div>
        
        <br>
        <button onclick="auth.signOut().then(()=>location='index.html')" class="btn-logout">
            Sign Out
        </button>

    </div>

<script>
async function loadDashboard() {
    const u = auth.currentUser;
    if (!u) return; // Wait for Auth

    const roll = u.email.split("@")[0];
    document.getElementById("u-roll").innerText = "ID: " + roll.toUpperCase();

    // Fetch Attendance Data
    const snap = await db.collection("attendance")
        .where("roll", "==", roll)
        .get();

    let total = 0, present = 0, late = 0;
    let records = [];

    snap.forEach(doc => {
        const d = doc.data();
        records.push(d);
        total++;
        if(d.status === "PRESENT") present++;
        if(d.status === "LATE") { present++; late++; }
    });

    // 1. Update Stats
    document.getElementById("st-total").innerText = total;
    document.getElementById("st-present").innerText = present;
    document.getElementById("st-late").innerText = late;

    // 2. Calculate Percentage
    const percent = total ? Math.round((present / total) * 100) : 0;
    document.getElementById("center-score").innerText = percent + "%";

    // 3. Render Chart (Doughnut)
    const ctx = document.getElementById('attChart').getContext('2d');
    
    // Destroy old chart if exists (prevents glitching on reload)
    if(window.myChart instanceof Chart) { window.myChart.destroy(); }

    window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Late', 'Absent'],
            datasets: [{
                data: [present - late, late, total - present],
                backgroundColor: ['#10b981', '#f59e0b', '#f1f5f9'],
                borderWidth: 0,
                borderRadius: 5,
                cutout: '75%', // Thinner ring
                spacing: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            animation: { animateScale: true, animateRotate: true }
        }
    });

    // 4. Render List (Newest First)
    records.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
    
    let html = "";
    const mocks = ["Algorithm Lab", "System Design", "Physics II", "Data Structures", "Soft Skills"];

    records.slice(0, 10).forEach((r, index) => {
        let title = r.subject || mocks[index % mocks.length] + " (Mock)";
        let isLab = title.toLowerCase().includes("lab");
        let statusClass = "st-present";
        
        if(r.status === "LATE") statusClass = "st-late";
        if(r.status === "ABSENT") statusClass = "st-fail";

        let dateObj = r.timestamp ? r.timestamp.toDate() : new Date();
        let timeStr = dateObj.toLocaleDateString(undefined, {month:'short', day:'numeric'}) + 
                      " â€¢ " + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        html += `
        <div class="session-item">
            <div class="s-icon ${isLab ? 'icon-lab' : 'icon-class'}">
                ${isLab ? 'ðŸ’»' : 'ðŸ“˜'}
            </div>
            <div class="s-info">
                <div class="s-subject">${title}</div>
                <div class="s-time">${timeStr}</div>
            </div>
            <div class="s-status ${statusClass}">${r.status}</div>
        </div>`;
    });

    if(total === 0) html = "<div style='padding:20px; text-align:center; color:#94a3b8;'>No records yet</div>";
    
    document.getElementById("roster").innerHTML = html;
}

auth.onAuthStateChanged(loadDashboard);
</script>

</body>
</html>