<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">

<style>
#box{
  text-align:center;
  margin-top:60px;
  opacity:0;
  animation:fade .6s forwards;
}

@keyframes fade{
 from{opacity:0}
 to{opacity:1}
}

.step{
 margin:12px;
 font-weight:600;
}
</style>

</head>

<body>

<div class="nav">SMART ATTENDANCE SYSTEM</div>

<div class="card" id="box">

<h3 id="msg">Initializing secure session…</h3>

<div class="loader" style="display:block"></div>

<p class="step" id="s1"></p>
<p class="step" id="s2"></p>
<p class="step" id="s3"></p>
<p class="step" id="s4"></p> 

</div>

<script>

// --- CONFIGURATION ---
// REPLACE THESE WITH YOUR COLLEGE COORDINATES
const COLLEGE_LAT = 19.254615; // Example: Mumbai
const COLLEGE_LNG = 72.866161; 
const ALLOWED_RADIUS = 20000; // Increased for testing (20km). Set to 500 for prod.

// --- GEOMETRY UTILS ---
function getDist(lat1, lon1, lat2, lon2) {
  var R = 6371; // Radius of earth in km
  var dLat = deg2rad(lat2-lat1);
  var dLon = deg2rad(lon2-lon1); 
  var a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c; // Dist in km
  return d * 1000; // Return meters
}

function deg2rad(deg) {
  return deg * (Math.PI/180)
}

// --- LOCATION CHECK ---
function checkLocation(){
    return new Promise((resolve, reject)=>{
        if(!navigator.geolocation){
            // If browser blocks geo, we assume false for security
            alert("Geolocation not supported. Attendance blocked.");
            resolve(false);
            return;
        }

        navigator.geolocation.getCurrentPosition((pos)=>{
            let dist = getDist(pos.coords.latitude, pos.coords.longitude, COLLEGE_LAT, COLLEGE_LNG);
            console.log("Distance:", dist, "meters");

            if(dist <= ALLOWED_RADIUS){
                resolve(true);
            } else {
                alert("You are too far from campus (" + Math.round(dist) + "m). Attendance denied.");
                resolve(false);
            }
        }, (err)=>{
            // If user clicks "Block" on location popup
            alert("Location permission denied. Cannot verify attendance.");
            resolve(false);
        }, {enableHighAccuracy:true});
    });
}


let steps=[
 "Ensuring GPS location integrity",
 "Checking browser security",
 "Validating device profile",
 "Loading attendance services"
];

let i=0;

async function run(){

 // INTELLIGENT CHECK AT STEP 0
 if(i==0){
    let allowed = await checkLocation();
    
    // Logic: If not allowed, stop the loading screen here.
    if(!allowed) {
        document.getElementById("msg").innerText = "LOCATION CHECK FAILED";
        document.querySelector(".loader").style.display="none";
        document.getElementById("msg").style.color = "red";
        return; // STOP EXECUTION
    }
 }

 if(i<steps.length){
   document.getElementById("msg").innerText=steps[i];
   // This line was crashing because s4 didn't exist
   document.getElementById("s"+(i+1)).innerText="✔ "+steps[i];       
   i++;
   setTimeout(run,900);
 }
 else{
   setTimeout(()=>{
     document.getElementById("box").style.opacity=0;

     setTimeout(()=>{
       location="student.html";
     },600);

   },800);
 }
}

setTimeout(run,800);

</script>

</body>
</html>